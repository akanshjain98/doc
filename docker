
# Stage 1: Prepare dependencies context (only what is needed for install)
FROM node:22-bookworm-slim@sha256:88f44fbb06cc98e1451e4e015c122f84030ec55c603f753ed97b889db0bb8d4d AS deps
WORKDIR /app
COPY backstage.json package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn
COPY packages/*/package.json packages/*/package.json
COPY plugins/*/package.json plugins/*/package.json


# Stage 2: Build dependencies and app
FROM node:22-bookworm-slim@sha256:88f44fbb06cc98e1451e4e015c122f84030ec55c603f753ed97b889db0bb8d4d AS build
WORKDIR /app

# Install system dependencies in one layer, clean up after
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends python3 g++ build-essential libsqlite3-dev && \
    rm -rf /var/lib/apt/lists/*

COPY --from=deps --chown=node:node /app .

USER node

# Install JS deps with cache
RUN --mount=type=cache,target=/home/node/.cache/yarn,sharing=locked,uid=1000,gid=1000 \
    yarn install --immutable

# Copy source for build (only what is needed)
COPY --chown=node:node packages packages
COPY --chown=node:node plugins plugins
COPY --chown=node:node .yarnrc.yml .
COPY --chown=node:node .yarn ./.yarn
COPY --chown=node:node app-config*.yaml ./
COPY --chown=node:node catalog-info.yml ./
COPY --chown=node:node packages/backend/static-templates ./packages/backend/static-templates
COPY --chown=node:node examples/catalogs/* ./

# Build
RUN yarn tsc && yarn --cwd packages/backend build

# Unpack build artifacts
RUN mkdir -p packages/backend/dist/skeleton packages/backend/dist/bundle \
    && tar xzf packages/backend/dist/skeleton.tar.gz -C packages/backend/dist/skeleton \
    && tar xzf packages/backend/dist/bundle.tar.gz -C packages/backend/dist/bundle


# Stage 3: Production image, only runtime deps and built output
FROM node:22-bookworm-slim@sha256:88f44fbb06cc98e1451e4e015c122f84030ec55c603f753ed97b889db0bb8d4d AS prod
WORKDIR /app

# Install only runtime system deps
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends python3 libsqlite3-dev && \
    rm -rf /var/lib/apt/lists/*

COPY --from=build --chown=node:node /app .

USER node

ENV NODE_ENV=production
ENV NODE_OPTIONS="--no-node-snapshot"

# Start the backend
CMD ["node", "packages/backend", "--config", "app-config.yaml", "--config", "app-config.production.yaml"]
